<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ðŸŽµ Schallplatten-Tracker (HTML) â€“ mit Barcode</title>
<meta name="description" content="Einfacher Vinyl-Tracker, lÃ¤uft komplett im Browser.">
<link rel="icon" href="data:,">
<style>
  :root {
      --accent: #e30613;
      --accent-2: #ff6b73;
      --accent-dark: #c00510;
      --bg: #0f1216;
      --card: #161a20;
      --card-2: #1b2028;
      --text: #e9eef5;
      --muted: #9aa3af;
      --ring: rgba(0,0,0,0.28);
      --ring-2: rgba(255,255,255,0.06);
      --chip: #232a34;
      --ok:#20c997;
    }
    [data-theme="light"]{
      --bg: #f6f8fb;
      --card: #ffffff;
      --card-2: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --ring: rgba(15,23,42,0.1);
      --ring-2: rgba(0,0,0,0.06);
      --chip: #eef2f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 900px at 80% -20%, #1c212a 0%, var(--bg) 40%) no-repeat, var(--bg); color:var(--text);}
    a{color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:18px 20px 100px;}
    header{padding:28px 20px 8px; position: sticky; top: 0; backdrop-filter: blur(8px); background: linear-gradient(to bottom, rgba(15,18,22,.72), rgba(15,18,22,.32) 60%, transparent); z-index:10;}
    [data-theme="light"] header{ background: linear-gradient(to bottom, rgba(255,255,255,.9), rgba(255,255,255,.6) 60%, transparent); }
    .head{ max-width: 1200px; margin: 0 auto; display:flex; align-items:center; justify-content: space-between; gap: 10px; }
    h1{margin:0;letter-spacing:.6px; font-size: clamp(22px, 3.5vw, 34px);}
    .sub{ color: var(--muted); font-size:.95rem; }
    .theme-toggle{ border:1px solid var(--ring-2); background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); color: inherit; border-radius: 999px; padding: 8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px; box-shadow: 0 4px 16px var(--ring); }
    .card { background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid var(--ring-2); border-radius: 14px; box-shadow: 0 8px 30px var(--ring); }
    .stats{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .stat{ background: linear-gradient(180deg, var(--card-2) 0%, var(--card) 100%); border:1px solid var(--ring-2); border-radius: 12px; padding:12px; }
    .stat .v{ font-weight:800; font-size:22px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input, textarea, select { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px; border:1px solid #2a313b; background:#0f1319; color:var(--text); font-size:14px; }
    [data-theme="light"] input,[data-theme="light"] textarea,[data-theme="light"] select{ background:#fff; border-color:#e5e7eb; color:var(--text); }
    textarea{ resize:vertical; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    button { appearance:none; border:1px solid var(--ring-2); background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; box-shadow: 0 6px 18px var(--ring); }
    button.primary{ background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%); color:#fff; border-color:transparent; box-shadow: 0 8px 16px rgba(227,6,19,.3); font-weight:700; }
    button.ghost{ background:transparent; }
    .muted{ color:var(--muted); }
    .grid{ display:grid; gap:10px; }
    .grid-2{ grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .table{ width:100%; border-collapse:collapse; }
    .table th, .table td { text-align:left; padding:10px; border-bottom:1px solid var(--ring-2); vertical-align:top; }
    .table th { font-weight:600; font-size:13px; color:var(--muted); }
    .cover { width:58px; height:58px; border-radius:8px; object-fit:cover; background:#222; display:block; }
    .badges { display:flex; gap:6px; flex-wrap:wrap; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; background:var(--chip); border:1px solid var(--ring-2); }
    .hidden{ display:none; }
    dialog { border:none; border-radius:16px; padding:0; max-width:720px; width:calc(100% - 24px); background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); color:var(--text); border:1px solid var(--ring-2); }
    dialog .dialog-body { padding:16px; }
    dialog::backdrop { background:rgba(0,0,0,0.55); }
    .ok{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border:1px solid var(--ring-2); border-radius:999px; background:var(--chip); color:var(--text); }
</style>
</head>
<body>
  <div class="container">
    <header>
  <div class="head">
    <div>
      <h1>SCHALLPLATTEN-TRACKER</h1>
      <div class="sub">mit Barcode-Autofill</div>
    </div>
    <div class="row right">
      <button id="themeToggle" class="theme-toggle" aria-label="Theme umschalten">ðŸŒ™ <span id="themeLabel">Dark</span></button>
      <div class="actions">
        <span id="firebase-status" class="ok" title="Firebase Ladezustand">ðŸ”Œ Firebase lÃ¤dtâ€¦</span>
        <button id="btn-export-json">Export JSON</button>
        <button id="btn-export-csv">Export CSV</button>
        <button id="btn-import">Import JSON</button>
        <input id="file-import" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
  </div>
</header>

    <section class="stats">
      <div class="stat"><div class="muted">Gesamtanzahl</div><div class="v" id="stat-count">0</div></div>
      <div class="stat"><div class="muted">Ausgaben (geschÃ¤tzt)</div><div class="v" id="stat-spent">0,00 â‚¬</div></div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row">
        <div style="flex:1; min-width:240px">
          <label for="search">Suche</label>
          <input id="search" placeholder="KÃ¼nstler, Titel, Label oder Tag" />
        </div>
        <div style="width:180px">
          <label for="formatFilter">Format</label>
          <select id="formatFilter"><option value="">(alle)</option></select>
        </div>
        <div style="width:220px">
          <label for="condFilter">Zustand</label>
          <select id="condFilter"><option value="">(alle)</option></select>
        </div>
        <div style="width:220px">
          <label for="sortBy">Sortierung</label>
          <select id="sortBy">
            <option value="createdAt-desc">Neueste zuerst</option>
            <option value="artist-asc">KÃ¼nstler Aâ€“Z</option>
            <option value="title-asc">Titel Aâ€“Z</option>
            <option value="year-desc">Jahr â†“</option>
            <option value="price-desc">Preis â†“</option>
            <option value="color-asc">Farbe Aâ€“Z</option>
          </select>
        </div>
        <div class="row" style="gap:6px"><button id="btn-reset">Reset</button><button id="btn-cloud">Cloud laden</button></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="grid grid-2">
        <div>
          <label for="barcode">Barcode einscannen oder eingeben (EAN/UPC)</label>
          <input id="barcode" inputmode="numeric" placeholder="z. B. 0888750663828" />
          <div class="note">USB-Scanner tippt den Code + Enter. Nach Enter wird automatisch gesucht.</div>
        </div>
        <div>
          <label for="discogsToken">Optional: Discogs-Token (fÃ¼r bessere Treffer)</label>
          <input id="discogsToken" placeholder="Discogs API-Token (optional)" />
          <div class="note">Ohne Token wird MusicBrainz + Cover Art Archive genutzt.</div>
        </div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="btn-lookup" class="primary">Infos per Barcode holen</button>
        <span id="lookup-status" class="muted"></span>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <strong>Sammlung</strong>
        <button id="btn-add">Neue Platte</button>
      </div>
      <table class="table" id="table">
        <thead>
          <tr>
            <th>Cover</th>
            <th>KÃ¼nstler â€” Titel<br><span class="muted">Label â€¢ Jahr â€¢ Format â€¢ Zustand</span></th>
            <th>Tags / Notizen</th>
            <th>Farbe</th>
            <th>Preis</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <dialog id="dlg">
      <form method="dialog">
        <div class="dialog-body">
          <h3 id="dlg-title" style="margin:8px 0 12px 0">Platte</h3>
          <div class="grid grid-2">
            <div><label>KÃ¼nstler*in</label><input id="f-artist" placeholder="z. B. Nils Frahm" /></div>
            <div><label>Titel</label><input id="f-title" placeholder="z. B. All Melody" /></div>
            <div><label>Jahr</label><input id="f-year" /></div>
            <div><label>Label</label><input id="f-label" /></div>
            <div><label>Katalog-Nr.</label><input id="f-catalog" /></div>
            <div>
              <label>Format</label>
              <select id="f-format"></select>
            </div>
            <div><label>Farbe</label><input id="f-color" placeholder="schwarz / clear / splatterâ€¦" /></div>
            <div>
              <label>Zustand</label>
              <select id="f-condition"></select>
            </div>
            <div><label>Bewertung (0â€“5)</label><input id="f-rating" type="number" min="0" max="5" step="1" /></div>
            <div><label>Preis (â‚¬)</label><input id="f-price" type="number" min="0" step="0.01" /></div>
            <div><label>Kaufdatum</label><input id="f-date" type="date" /></div>
            <div><label>Cover-URL</label><input id="f-cover" placeholder="https://â€¦" /></div>
            <div class="grid" style="grid-column:1/-1"><label>Tags (mit Komma)</label><input id="f-tags" placeholder="ambient, 90s" /></div>
            <div class="grid" style="grid-column:1/-1"><label>Notizen</label><textarea id="f-notes" rows="4" placeholder="Pressung, Matrix, Besonderheitenâ€¦"></textarea></div>
          </div>
          <div class="actions" style="margin-top:12px; justify-content:flex-end">
            <button id="btn-cancel" class="ghost">Abbrechen</button>
            <button id="btn-save" class="primary">Speichern</button>
          </div>
        </div>
      </form>
    </dialog>
  </div>

  
  
  <!-- Firebase (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDdGIkn7dNmYlaaIakZ1EWH9dtdpNvVpUc",
      authDomain: "platten-c1817.firebaseapp.com",
      projectId: "platten-c1817",
      storageBucket: "platten-c1817.firebasestorage.app",
      messagingSenderId: "376624319679",
      appId: "1:376624319679:web:28e871bf481b27342e4a0a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const s = document.getElementById("firebase-status");
    if (s) s.textContent = "âœ… Firestore verbunden (ohne Auth)";

    window.firebaseApp = app;
    window.firebaseDB = db;

    // Sofort signalisieren, dass Firestore verfÃ¼gbar ist
    document.dispatchEvent(new CustomEvent('firebase-ready', { detail: {} }));
  </script>



  <!-- Deine App-Logik (unverÃ¤ndert) -->
  <script>
  (function(){
    const FORMATS = ["LP","EP","Single","12\"","7\"","Tape","CD","Digital"];
    const CONDITIONS = ["Mint (M)","Near Mint (NM)","Very Good+ (VG+)","Very Good (VG)","Good (G)","Poor (P)"];
    const STORAGE_KEY = "vinyl-tracker.html.v1";

    // --- State ---
    let items = loadLocal();
    let editingId = null;

    // --- Elements ---
    const el = (id) => document.getElementById(id);
    const tbody = el('tbody');
    const dlg = el('dlg');

    // Populate selects
    function fillSelect(id, opts){ const s = el(id); s.innerHTML = ''; opts.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); }); }
    fillSelect('f-format', FORMATS); fillSelect('f-condition', CONDITIONS);
    // filters
    (function(){ const f = el('formatFilter'); FORMATS.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; f.appendChild(o); }); })();
    (function(){ const f = el('condFilter'); CONDITIONS.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; f.appendChild(o); }); })();

    // --- Render ---
    function render(){
      const q = el('search').value.trim().toLowerCase();
      const ff = el('formatFilter').value; const cf = el('condFilter').value; const sb = el('sortBy').value;
      let list = items.filter(i=> (i.artist + ' ' + i.title + ' ' + (i.label||'') + ' ' + (i.tags||[]).join(' ')).toLowerCase().includes(q));
      if (ff) list = list.filter(i => i.format === ff);
      if (cf) list = list.filter(i => i.condition === cf);
      const [field, dir] = sb.split('-');
      list.sort((a,b)=>{
        const va = (a[field] ?? '').toString(); const vb = (b[field] ?? '').toString();
        if (field === 'price' || field === 'rating') { const na=Number(va||0), nb=Number(vb||0); return dir==='asc'? na-nb : nb-na; }
        return dir==='asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      });

      tbody.innerHTML = '';
      for (const i of list){
        const tr = document.createElement('tr');
        const coverTd = document.createElement('td');
        const img = document.createElement('img'); img.className='cover'; img.alt='Cover'; img.src = i.coverUrl || '';
        if (!i.coverUrl) { img.style.background = '#222'; }
        coverTd.appendChild(img); tr.appendChild(coverTd);
        const meta = document.createElement('td');
        const title = document.createElement('div'); title.innerHTML = `<strong>${esc(i.artist)}</strong> â€” ${esc(i.title)}`; meta.appendChild(title);
        const line = document.createElement('div'); line.className='muted'; line.textContent = [i.label, i.year, i.format, i.condition].filter(Boolean).join(' â€¢ '); meta.appendChild(line);
        tr.appendChild(meta);
        const notes = document.createElement('td');
        const tags = document.createElement('div'); tags.className='badges';
        (i.tags||[]).forEach(t=>{ const b=document.createElement('span'); b.className='badge'; b.textContent = '#'+t; tags.appendChild(b); });
        notes.appendChild(tags);
        if (i.notes) { const p=document.createElement('div'); p.style.marginTop='6px'; p.textContent=i.notes; notes.appendChild(p); }
        tr.appendChild(notes);
        const color = document.createElement('td'); color.textContent = i.color || ''; tr.appendChild(color);
const price = document.createElement('td'); price.textContent = i.price!=null ? (Number(i.price).toFixed(2)+' â‚¬') : ''; tr.appendChild(price);
        const actions = document.createElement('td'); actions.style.whiteSpace='nowrap';
        const ebtn = document.createElement('button'); ebtn.textContent='Bearbeiten'; ebtn.addEventListener('click', ()=>openEditor(i.id)); actions.appendChild(ebtn);
        const dbtn = document.createElement('button'); dbtn.textContent='LÃ¶schen'; dbtn.style.marginLeft='6px'; dbtn.addEventListener('click', ()=>{ if (confirm('Wirklich lÃ¶schen?')) { items = items.filter(x=>x.id!==i.id); save(); render(); stats(); } }); actions.appendChild(dbtn);
        tr.appendChild(actions);
        tbody.appendChild(tr);
      }

      // stats
      stats();
    }

    function stats(){
      el('stat-count').textContent = String(items.length);
      const spent = items.reduce((s,i)=> s + (Number(i.price)||0), 0);
      el('stat-spent').textContent = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR' }).format(spent);
    }

    function esc(s){ return (s||'').toString().replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    
    
    // --- Storage (Ã¶ffentliche Firestore-Collection, keine Auth) ---
    async function fsLoadAll(){
      const status = document.getElementById('firebase-status');
      try{
        if (!window.firebaseDB) return null;
        const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const colRef = collection(window.firebaseDB, 'publicRecords');
        const snap = await getDocs(colRef);
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        return arr;
      } catch(e){
        console.warn('Firestore load failed', e);
        if (status) status.textContent = 'ðŸš« Firestore: ' + (e?.code || 'Fehler');
        return null;
      }
    }

    async function fsUpsert(item){
      try{
        if (!window.firebaseDB) return false;
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const ref = doc(window.firebaseDB, 'publicRecords', item.id);
        await setDoc(ref, item, { merge: true });
        return true;
      } catch(e){
        console.warn('Firestore upsert failed', e);
        return false;
      }
    }

    async function fsDelete(id){
      try{
        if (!window.firebaseDB) return false;
        const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const ref = doc(window.firebaseDB, 'publicRecords', id);
        await deleteDoc(ref);
        return true;
      } catch(e){
        console.warn('Firestore delete failed', e);
        return false;
      }
    }

    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch{ return []; } }
 catch{ return []; } }


    // --- Editor ---
    function openEditor(id){
      editingId = id || crypto.randomUUID();
      const data = items.find(x=>x.id===id) || { id: editingId, artist:'', title:'', format:'LP', condition:'Very Good+ (VG+)', tags:[], createdAt: new Date().toISOString() };
      el('dlg-title').textContent = id ? 'Bearbeiten' : 'Neue Platte';
      el('f-artist').value = data.artist||''; el('f-title').value = data.title||''; el('f-year').value = data.year||''; el('f-label').value = data.label||'';
      el('f-catalog').value = data.catalog||''; el('f-format').value = data.format||'LP'; el('f-color').value = data.color||''; el('f-condition').value = data.condition||'';
      el('f-rating').value = data.rating ?? '';
      el('f-price').value = data.price ?? '';
      el('f-date').value = data.purchaseDate ? data.purchaseDate.slice(0,10) : '';
      el('f-cover').value = data.coverUrl || '';
      el('f-tags').value = (data.tags||[]).join(', ');
      el('f-notes').value = data.notes || '';
      dlg.showModal();
    }

    function saveEditor(){
      const rec = {
        id: editingId || crypto.randomUUID(),
        artist: el('f-artist').value.trim(),
        title: el('f-title').value.trim(),
        year: el('f-year').value.trim(),
        label: el('f-label').value.trim(),
        catalog: el('f-catalog').value.trim(),
        format: el('f-format').value,
        color: el('f-color').value.trim(),
        condition: el('f-condition').value,
        rating: Number(el('f-rating').value||0),
        price: el('f-price').value ? Number(el('f-price').value) : undefined,
        purchaseDate: el('f-date').value ? new Date(el('f-date').value).toISOString() : undefined,
        coverUrl: el('f-cover').value.trim(),
        tags: el('f-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        notes: el('f-notes').value.trim(),
        createdAt: items.find(x=>x.id===editingId)?.createdAt || new Date().toISOString()
      };
      if (!rec.artist || !rec.title) { alert('Bitte KÃ¼nstler und Titel ausfÃ¼llen.'); return; }
      const i = items.findIndex(x=>x.id===rec.id);
      if (i>=0) items[i] = rec; else items.unshift(rec);
      fsUpsert(rec).then((ok)=>{ if(!ok) saveLocal(); }).finally(()=>{ render(); dlg.close(); });
    }

    // --- Barcode Lookup ---
    async function lookupByBarcode(code){
      const status = el('lookup-status');
      status.textContent = 'Sucheâ€¦';
      const clean = (code||'').replace(/\D/g,'');
      if (!clean) { status.textContent = 'Kein gÃ¼ltiger Code.'; return null; }

      // 1) MusicBrainz Release-Suche
      try {
        const mbUrl = `https://musicbrainz.org/ws/2/release/?query=barcode:${clean}&fmt=json`;
        const mb = await fetch(mbUrl, { headers: { 'User-Agent': 'VinylTrackerHTML/1.0 (barcode lookup)', 'Accept': 'application/json' } });
        const data = await mb.json();
        const hit = data.releases && data.releases[0];
        if (hit){
          const artist = (hit["artist-credit"]||[]).map(a=> a.name || a.artist?.name).filter(Boolean).join(', ');
          const title = hit.title || '';
          const year = (hit.date||'').slice(0,4);
          const label = (hit["label-info"]||[])[0]?.label?.name || '';
          const catalog = (hit["label-info"]||[])[0]?.catalog_number || '';
          const mbid = hit.id;
          // Cover Art Archive (Release â†’ front)
          let cover = '';
          try {
            const caa = await fetch(`https://coverartarchive.org/release/${mbid}`);
            if (caa.ok) {
              const ca = await caa.json();
              const front = (ca.images||[]).find(img=>img.front) || ca.images?.[0];
              cover = front?.thumbnails?.small || front?.image || '';
            }
          } catch {}
          status.textContent = 'Treffer aus MusicBrainz';
          return { artist, title, year, label, catalog, coverUrl: cover };
        }
      } catch (e){ console.warn(e); }

      // 2) Optional: Discogs (wenn Token vorhanden)
      const token = el('discogsToken').value.trim();
      if (token){
        try {
          const dcUrl = `https://api.discogs.com/database/search?barcode=${clean}&type=release&token=${encodeURIComponent(token)}`;
          const dc = await fetch(dcUrl, { headers: { 'User-Agent': 'VinylTrackerHTML/1.0' } });
          const data = await dc.json();
          const first = (data.results||[])[0];
          if (first){
            const details = { artist: (first.artist || (first.title||'').split(' - ')[0] || ''), title: (first.title||'').split(' - ').slice(1).join(' - '), year: first.year? String(first.year):'', label: (first.label||[])[0]||'', catalog: (first.catno||''), coverUrl: first.cover_image||first.thumb||'' };
            status.textContent = 'Treffer aus Discogs';
            return details;
          }
        } catch (e){ console.warn(e); }
      }

      status.textContent = 'Nichts gefunden.';
      return null;
    }

    // Autofill into editor
    async function autofillFromBarcode(){
      const code = el('barcode').value;
      const info = await lookupByBarcode(code);
      if (!info){ return; }
      openEditor(null);
      el('f-artist').value = info.artist || '';
      el('f-title').value = info.title || '';
      el('f-year').value = info.year || '';
      el('f-label').value = info.label || '';
      el('f-catalog').value = info.catalog || '';
      el('f-cover').value = info.coverUrl || '';
    }

    // --- Events ---
    el('btn-add').addEventListener('click', ()=> openEditor(null));
    el('btn-save').addEventListener('click', (e)=>{ e.preventDefault(); saveEditor(); });
    el('btn-cancel').addEventListener('click', (e)=>{ e.preventDefault(); dlg.close(); });

    el('btn-reset').addEventListener('click', ()=>{ el('search').value=''; el('formatFilter').value=''; el('condFilter').value=''; el('sortBy').value='createdAt-desc'; render(); });
    ['search','formatFilter','condFilter','sortBy'].forEach(id=> el(id).addEventListener('input', render));
    el('btn-cloud').addEventListener('click', async ()=>{ const cloud = await fsLoadAll(); if (Array.isArray(cloud)) { items = cloud; render(); } });

    el('btn-lookup').addEventListener('click', ()=> autofillFromBarcode());
    el('barcode').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); autofillFromBarcode(); } });

    // Export / Import
    el('btn-export-json').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      download(blob, `vinyl-export-${new Date().toISOString().slice(0,10)}.json`);
    });
    el('btn-export-csv').addEventListener('click', ()=>{
      const headers = ["artist","title","year","label","catalog","format","color","condition","tags","notes","rating","purchaseDate","price","coverUrl","id","createdAt"]; 
      const rows = items.map(i => headers.map(h => {
        const val = h === 'tags' ? (i.tags||[]).join('|') : (i[h] ?? '');
        const s = String(val).replaceAll('"', '""');
        return '"'+s+'"';
      }).join(','));
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      download(blob, `vinyl-export-${new Date().toISOString().slice(0,10)}.csv`);
    });
    el('btn-import').addEventListener('click', ()=> el('file-import').click());
    el('file-import').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      try { const text = await file.text(); const parsed = JSON.parse(text); if (!Array.isArray(parsed)) throw new Error(); items = parsed; save(); render(); }
      catch { alert('Konnte Datei nicht laden (erwarte JSON aus Export).'); }
      finally { e.target.value=''; }
    });

    function download(blob, name){ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); }

    // Firebase ready â†’ Cloud laden
    document.addEventListener('firebase-ready', async () => {
      const cloud = await fsLoadAll();
      if (Array.isArray(cloud)) {
        items = cloud;
        render();
      }
    });

    // initial
    render();
  })();
  </script>

  <script>
    (function(){
      const els = { themeToggle: document.getElementById('themeToggle'), themeLabel: document.getElementById('themeLabel') };
      function applyTheme(t){
        document.documentElement.setAttribute('data-theme', t);
        if (els.themeLabel) els.themeLabel.textContent = t === 'light' ? 'Light' : 'Dark';
        if (els.themeToggle) els.themeToggle.firstChild.nodeValue = t === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
        localStorage.setItem('theme', t);
      }
      const saved = localStorage.getItem('theme') || 'dark';
      applyTheme(saved);
      if (els.themeToggle) els.themeToggle.addEventListener('click', ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='light' ? 'dark' : 'light'));
    })();
  </script>
</body>
</html>
